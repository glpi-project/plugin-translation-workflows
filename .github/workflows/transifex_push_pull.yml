name: "Transifex Push / Pull"

on:
  workflow_call:
    secrets:
      tx_token:
        required: true
    inputs:
      branch:
        required: false
        default: 'main'
        type: 'string'

jobs:
  ci:
    name: "Translations"
    runs-on: ubuntu-latest
    container:
      image: "ghcr.io/glpi-project/plugin-builder"
    steps:

    ##########################################
    # Checkout repository                    #
    ##########################################
    - name: "Checkout"
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}

    ##########################################
    # Install depdendencies                  #
    ##########################################
    - name: Install Dependencies
      run: |
        composer install --no-progress --no-suggest --no-interaction --prefer-dist

    ##########################################
    # Generate <plugin>.pot file             #
    ##########################################
    - name: "Generate <plugin>.pot file"
      run: ./vendor/bin/extract-locales


    ##########################################
    # Push and Pull transifiex source        #
    ##########################################
    - name: Push source file (.pot)
      uses: transifex/cli-action@v2
      with:
        args: push
        token: ${{ secrets.tx_token }}

    - name: Clean Transifex CLI
      run: rm -fr /tmp/tx

    - name: Pull source file (.po / .mo)
      uses: transifex/cli-action@v2
      with:
        args: pull --force --all --minimum-perc=80
        token: ${{ secrets.tx_token }}

    ##########################################
    # Generate .mo files                     #
    ##########################################
    - name: "Compil mo"
      run: ./vendor/bin/plugin-release --compile-mo

    ##########################################
    # Generate random branch name            #
    ##########################################
    - name: "Generate target branch name"
      run: echo BRANCH_NAME=transifex/i18n-updates--$(date +%s) >> $GITHUB_ENV

    - name: "Check status"
      id: "check-status"
      run: |
        if [[ `git status --porcelain locales/*.mo` ]]; then
          echo "CREATE_PR=yes" >> $GITHUB_OUTPUT
        else
          echo "CREATE_PR=no" >> $GITHUB_OUTPUT
        fi


    ##########################################
    # Create Pull Request                    #
    ##########################################
    - name: Create Pull Request
      if: ${{ steps.check-status.outputs.CREATE_PR == 'yes' }}
      id: cpr
      uses: peter-evans/create-pull-request@v7
      with:
        commit-message: Update locales
        committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
        author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
        signoff: false
        branch: ${{ env.BRANCH_NAME }}
        base: ${{ inputs.branch }}
        add-paths: locales/
        labels: i18n
        delete-branch: true
        title: 'Chore(i18n): update translations'
        body: Auto-generated `PR` to update translations
        draft: false

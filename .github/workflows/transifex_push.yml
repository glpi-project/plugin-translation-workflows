name: "Transifex Push"

on:
  workflow_call:
    secrets:
      tx_token:
        required: true
    inputs:
      branch:
        required: false
        default: 'main'
        type: 'string'

jobs:
  ci:
    name: "Translations"
    runs-on: ubuntu-latest
    container:
      image: "ghcr.io/glpi-project/plugin-builder"
    steps:

    ##########################################
    # Checkout repository                    #
    ##########################################
    - name: "Checkout"
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}

    ##########################################
    # Install depdendencies                  #
    ##########################################
    - name: Install xgettext
      run: |
        sudo apt-get install gettext libgettextpo-dev python3-dev python3-pip libffi-dev libxml2-dev libxslt-dev
        pip install lxml git
        pip install gitpython
        pip install PyGithub
        pip install termcolor


    ##########################################
    # Run composer                           #
    ##########################################
    - name: Install Dependencies
      uses: php-actions/composer@v6
      with:
        dev: yes

    ##########################################
    # Generate <plugin>.pot file             #
    ##########################################
    - name: "Generate <plugin>.pot file"
      run: ./vendor/bin/extract-locales


    ##########################################
    # Push transifiex source puglin.pot #
    ##########################################
    - name: Push source file (.pot)
      uses: transifex/cli-action@v2
      with:
        args: push
        token: ${{ secrets.tx_token }}
